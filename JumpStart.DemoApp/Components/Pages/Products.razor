@page "/products"
@using JumpStart.DemoApp.Clients
@using JumpStart.DemoApp.Shared.DTOs
@using JumpStart.Api.Clients
@using JumpStart.Repositories
@using System.ComponentModel.DataAnnotations
@inject IProductApiClient ProductClient
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Products</PageTitle>

<h1>Product Management</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

@if (loading)
{
    <p><em>Loading...</em></p>
}
else if (products != null)
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="CreateProduct">
            <i class="bi bi-plus-circle"></i> Create New Product
        </button>
        <button class="btn btn-secondary" @onclick="LoadLowStock">
            <i class="bi bi-exclamation-triangle"></i> Show Low Stock
        </button>
        <button class="btn btn-info" @onclick="LoadActive">
            <i class="bi bi-check-circle"></i> Show Active
        </button>
        <button class="btn btn-outline-secondary" @onclick="LoadProducts">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>

    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th @onclick="() => SortBy(nameof(ProductDto.Name))" style="cursor: pointer;">
                    Name @GetSortIcon(nameof(ProductDto.Name))
                </th>
                <th @onclick="() => SortBy(nameof(ProductDto.Description))" style="cursor: pointer;">
                    Description @GetSortIcon(nameof(ProductDto.Description))
                </th>
                <th @onclick="() => SortBy(nameof(ProductDto.Price))" style="cursor: pointer;">
                    Price @GetSortIcon(nameof(ProductDto.Price))
                </th>
                <th @onclick="() => SortBy(nameof(ProductDto.StockQuantity))" style="cursor: pointer;">
                    Stock @GetSortIcon(nameof(ProductDto.StockQuantity))
                </th>
                <th @onclick="() => SortBy(nameof(ProductDto.SKU))" style="cursor: pointer;">
                    SKU @GetSortIcon(nameof(ProductDto.SKU))
                </th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in products)
            {
                <tr>
                    <td>@product.Name</td>
                    <td>@product.Description</td>
                    <td>@product.Price.ToString("C")</td>
                    <td>@* Stock *@
                        <span class="badge @(product.StockQuantity <= 10 ? "bg-danger" : "bg-success")">
                            @product.StockQuantity
                        </span>
                    </td>
                    <td><code>@product.SKU</code></td>
                    <td> @* Active *@
                        @if (product.IsActive)
                        {
                            <span class="badge bg-success">Active</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactive</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" @onclick="() => EditProduct(product)">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteProduct(product.Id)">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (pagedResult != null && pagedResult.TotalCount > 0)
    {
        <div class="d-flex justify-content-between align-items-center">
            <div class="pagination-info">
                <p class="mb-0">
                    Page @pagedResult.PageNumber of @Math.Ceiling((double)pagedResult.TotalCount / pagedResult.PageSize)
                    <span class="text-muted">(Total items: @pagedResult.TotalCount)</span>
                </p>
            </div>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item @(pagedResult.PageNumber <= 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="PreviousPage" disabled="@(pagedResult.PageNumber <= 1)">
                            Previous
                        </button>
                    </li>
                    <li class="page-item active">
                        <span class="page-link">@pagedResult.PageNumber</span>
                    </li>
                    <li class="page-item @(pagedResult.PageNumber >= Math.Ceiling((double)pagedResult.TotalCount / pagedResult.PageSize) ? "disabled" : "")">
                        <button class="page-link" @onclick="NextPage" 
                                disabled="@(pagedResult.PageNumber >= Math.Ceiling((double)pagedResult.TotalCount / pagedResult.PageSize))">
                            Next
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    }
}

<!-- Create/Edit Modal -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditing ? "Edit Product" : "Create New Product")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <EditForm Model="@productForm" OnValidSubmit="SaveProduct">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                            <InputText id="name" class="form-control" @bind-Value="productForm.Name" />
                            <ValidationMessage For="@(() => productForm.Name)" />
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <InputTextArea id="description" class="form-control" rows="3" @bind-Value="productForm.Description" />
                            <ValidationMessage For="@(() => productForm.Description)" />
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="price" class="form-label">Price <span class="text-danger">*</span></label>
                                <InputNumber id="price" class="form-control" @bind-Value="productForm.Price" />
                                <ValidationMessage For="@(() => productForm.Price)" />
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="stock" class="form-label">Stock Quantity <span class="text-danger">*</span></label>
                                <InputNumber id="stock" class="form-control" @bind-Value="productForm.StockQuantity" />
                                <ValidationMessage For="@(() => productForm.StockQuantity)" />
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="sku" class="form-label">SKU <span class="text-danger">*</span></label>
                                <InputText id="sku" class="form-control" @bind-Value="productForm.SKU" />
                                <ValidationMessage For="@(() => productForm.SKU)" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="sku" class="form-label">Active <span class="text-danger">*</span></label>
                                <InputCheckbox id="active" @bind-Value="productForm.Active"/>
                                <ValidationMessage For="@(() => productForm.Active)" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@saving">
                            @if (saving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            @(isEditing ? "Update" : "Create") Product
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<ProductDto>? products;
    private PagedResult<ProductDto>? pagedResult;
    private bool loading = true;
    private bool showModal = false;
    private bool isEditing = false;
    private bool saving = false;
    private string? errorMessage;
    private string? successMessage;
    private int currentPage = 1;
    private const int pageSize = 20;
    private string? currentSortColumn;
    private bool sortDescending = false;

    private ProductFormModel productForm = new();

    protected override async Task OnInitializedAsync()
    {
        // Default sort by Name ascending
        currentSortColumn = nameof(ProductDto.Name);
        sortDescending = false;
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        loading = true;
        errorMessage = null;
        try
        {
            var options = new QueryOptions
            {
                PageNumber = currentPage,
                PageSize = pageSize,
                SortBy = currentSortColumn,
                SortDescending = sortDescending
            };

            pagedResult = await ProductClient.GetAllAsync(options);
            products = pagedResult.Items.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load products: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task SortBy(string columnName)
    {
        if (currentSortColumn == columnName)
        {
            // Toggle sort direction if clicking the same column
            sortDescending = !sortDescending;
        }
        else
        {
            // New column - default to ascending
            currentSortColumn = columnName;
            sortDescending = false;
        }

        // Reset to first page when sorting changes
        currentPage = 1;
        await LoadProducts();
    }

    private string GetSortIcon(string columnName)
    {
        if (currentSortColumn != columnName)
        {
            return ""; // No icon for non-sorted columns
        }

        return sortDescending 
            ? "▼" // Down arrow for descending
            : "▲"; // Up arrow for ascending
    }

    private async Task LoadLowStock()
    {
        loading = true;
        errorMessage = null;
        try
        {
            var lowStockProducts = await ProductClient.GetLowStockAsync(10);
            products = lowStockProducts.ToList();
            pagedResult = null; // Clear paging when filtering
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load low stock products: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadActive()
    {
        loading = true;
        errorMessage = null;
        try
        {
            var activeProducts = await ProductClient.GetActiveAsync();
            products = activeProducts.ToList();
            pagedResult = null; // Clear paging when filtering
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load active products: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task NextPage()
    {
        if (pagedResult != null && currentPage < Math.Ceiling((double)pagedResult.TotalCount / pagedResult.PageSize))
        {
            currentPage++;
            await LoadProducts();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadProducts();
        }
    }

    private void CreateProduct()
    {
        productForm = new ProductFormModel();
        isEditing = false;
        showModal = true;
        errorMessage = null;
        successMessage = null;
    }

    private void EditProduct(ProductDto product)
    {
        productForm = new ProductFormModel
        {
            Id = product.Id,
            Name = product.Name,
            Description = product.Description ?? string.Empty,
            Price = product.Price,
            StockQuantity = product.StockQuantity,
            SKU = product.SKU
        };
        isEditing = true;
        showModal = true;
        errorMessage = null;
        successMessage = null;
    }

    private async Task SaveProduct()
    {
        saving = true;
        errorMessage = null;
        try
        {
            if (isEditing)
            {
                // Update existing product
                var updateDto = new UpdateProductDto
                {
                    Id = productForm.Id,
                    Name = productForm.Name,
                    Description = productForm.Description,
                    Price = productForm.Price,
                    StockQuantity = productForm.StockQuantity,
                    IsActive = productForm.Active
                };

                await ProductClient.UpdateAsync(productForm.Id, updateDto);
                successMessage = $"Product '{productForm.Name}' updated successfully!";
            }
            else
            {
                // Create new product
                var createDto = new CreateProductDto
                {
                    Name = productForm.Name,
                    Description = productForm.Description,
                    Price = productForm.Price,
                    StockQuantity = productForm.StockQuantity,
                    SKU = productForm.SKU
                };

                await ProductClient.CreateAsync(createDto);
                successMessage = $"Product '{productForm.Name}' created successfully!";
            }

            CloseModal();
            await LoadProducts();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save product: {ex.Message}";
        }
        finally
        {
            saving = false;
        }
    }

    private async Task DeleteProduct(Guid id)
    {
        errorMessage = null;
        var product = products?.FirstOrDefault(p => p.Id == id);

        if (product == null)
            return;

        // In a real app, you'd want a confirmation dialog here
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{product.Name}'?"))
            return;

        try
        {
            if (await ProductClient.DeleteAsync(id))
            {
                successMessage = $"Product '{product.Name}' deleted successfully!";
                await LoadProducts();
            }
            else
            {
                errorMessage = "Failed to delete product. It may have already been deleted.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete product: {ex.Message}";
        }
    }

    private void CloseModal()
    {
        showModal = false;
        productForm = new();
    }

    // Form model for create/edit operations
    private class ProductFormModel
    {
        public Guid Id { get; set; }

        [Required(ErrorMessage = "Name is required")]
        [StringLength(200, ErrorMessage = "Name cannot exceed 200 characters")]
        public string Name { get; set; } = string.Empty;

        [StringLength(1000, ErrorMessage = "Description cannot exceed 1000 characters")]
        public string Description { get; set; } = string.Empty;

        [Required(ErrorMessage = "Price is required")]
        [Range(0.01, 1000000, ErrorMessage = "Price must be between $0.01 and $1,000,000")]
        public decimal Price { get; set; }

        [Required(ErrorMessage = "Stock quantity is required")]
        [Range(0, 1000000, ErrorMessage = "Stock quantity must be between 0 and 1,000,000")]
        public int StockQuantity { get; set; }

        [Required(ErrorMessage = "SKU is required")]
        [StringLength(50, ErrorMessage = "SKU cannot exceed 50 characters")]
        public string SKU { get; set; } = string.Empty;

        public bool Active { get; set; } = false;
    }
}
