@* Copyright Â©2026 Scott Blomfield *@
@*
 *  This program is free software: you can redistribute it and/or modify it under the terms of the
 *  GNU General Public License as published by the Free Software Foundation, either version 3 of the
 *  License, or (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 *  even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *  General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with this program. If not,
 *  see <https://www.gnu.org/licenses/>. 
 *@

@page "/question-types"
@using JumpStart.Forms.DTOs
@using JumpStart.Forms.Clients
@inject IFormsApiClient FormsClient
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Question Types</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Question Types</h1>
    <button class="btn btn-primary" @onclick="CreateNew">
        <i class="bi bi-plus-circle"></i> Create Question Type
    </button>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

@if (loading)
{
    <p><em>Loading question types...</em></p>
}
else if (questionTypes != null)
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Input Type</th>
                    <th>Has Options</th>
                    <th>Multiple Values</th>
                    <th>Display Order</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var questionType in questionTypes.OrderBy(qt => qt.DisplayOrder))
                {
                    <tr>
                        <td><code>@questionType.Code</code></td>
                        <td>@questionType.Name</td>
                        <td>@questionType.Description</td>
                        <td><code>@questionType.InputType</code></td>
                        <td>
                            @if (questionType.HasOptions)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </td>
                        <td>
                            @if (questionType.AllowsMultipleValues)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </td>
                        <td>@questionType.DisplayOrder</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => Edit(questionType.Id)">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(questionType)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!questionTypes.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No question types found. Create one to get started.
        </div>
    }
}

@if (showDeleteConfirmation && questionTypeToDelete != null)
{
    <JumpStart.DemoApp.Components.Shared.ConfirmationModal 
        Title="Delete Question Type"
        ConfirmButtonText="Delete"
        ConfirmButtonClass="btn-danger"
        OnClose="HandleDeleteModalClose">
        <Message>
            Are you sure you want to delete the question type '@questionTypeToDelete.Name'? This cannot be undone.
        </Message>
    </JumpStart.DemoApp.Components.Shared.ConfirmationModal>
}

@code {
    private IEnumerable<QuestionTypeDto>? questionTypes;
    private bool loading = true;
    private string? errorMessage;
    private string? successMessage;
    private bool showDeleteConfirmation = false;
    private QuestionTypeDto? questionTypeToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadQuestionTypes();
    }

    private async Task LoadQuestionTypes()
    {
        loading = true;
        errorMessage = null;
        try
        {
            questionTypes = await FormsClient.GetQuestionTypesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load question types: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void CreateNew()
    {
        Navigation.NavigateTo("/question-types/new");
    }

    private void Edit(Guid id)
    {
        Navigation.NavigateTo($"/question-types/edit/{id}");
    }

    private void ConfirmDelete(QuestionTypeDto questionType)
    {
        questionTypeToDelete = questionType;
        showDeleteConfirmation = true;
    }

    private async Task DeleteConfirmed()
    {
        if (questionTypeToDelete == null) return;

        showDeleteConfirmation = false;
        errorMessage = null;
        successMessage = null;

        try
        {
            await FormsClient.DeleteQuestionTypeAsync(questionTypeToDelete.Id);
            successMessage = $"Question type '{questionTypeToDelete.Name}' has been deleted.";
            await LoadQuestionTypes();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete question type: {ex.Message}";
        }
        finally
        {
            questionTypeToDelete = null;
        }
    }

    private async Task HandleDeleteModalClose(bool confirmed)
    {
        showDeleteConfirmation = false;

        if (confirmed)
        {
            await DeleteConfirmed();
        }
        else
        {
            questionTypeToDelete = null;
        }
    }
}
